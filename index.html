<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¹µí…Œì¼ì§€ì§€ CKTL.GG</title>
    <link rel="icon" href="favicon.png" type="image/png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { 
            --primary: #C2DA6B; 
            --primary-dark: #adc45b;
            --bg: #f7f8f2; 
        }
        
        body { font-family: 'Pretendard', -apple-system, sans-serif; background: var(--bg); padding: 20px; color: #2f3542; line-height: 1.5; margin-bottom: 100px; }
        .container { max-width: 600px; margin: 0 auto; }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in { animation: fadeInUp 0.4s ease-out forwards; }

        /* --- ê³µí†µ ì»´í¬ë„ŒíŠ¸ --- */
        #toast {
            position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
            background: rgba(47, 53, 66, 0.9); color: white; padding: 12px 25px;
            border-radius: 30px; font-size: 0.9rem; font-weight: bold; z-index: 1000;
            opacity: 0; transition: opacity 0.3s, bottom 0.3s; pointer-events: none;
        }
        #toast.show { opacity: 1; bottom: 100px; }

        .header-section { text-align: center; margin-bottom: 25px; position: relative; }
        .main-logo { max-width: 200px; width: 70%; height: auto; margin-bottom: 8px; }
        .main-title { margin: 0; font-size: 0.9rem; font-weight: 500; color: #747d8c; letter-spacing: 1px; text-transform: uppercase; }
        
        .guide-btn { 
            background: white; border: 1.5px solid #ddd; border-radius: 20px; 
            padding: 6px 15px; font-size: 0.75rem; color: #747d8c; cursor: pointer; 
            margin-top: 10px; font-weight: bold; transition: 0.2s;
            display: inline-flex; align-items: center; gap: 4px;
        }
        .guide-btn:hover { background: #f1f2f6; border-color: #ccc; }

        .search-filter-box { background: white; padding: 15px; border-radius: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 12px; }
        .search-input { width: 100%; padding: 12px; border: 2px solid #eee; border-radius: 12px; box-sizing: border-box; font-size: 1rem; outline: none; transition: 0.3s; margin-bottom: 12px; }
        .search-input:focus { border-color: var(--primary); }
        
        .category-tabs { display: flex; flex-wrap: wrap; gap: 8px; padding-bottom: 8px; }
        .cat-tab { padding: 8px 14px; border-radius: 12px; background: #f1f2f6; border: none; font-size: 0.85rem; cursor: pointer; color: #57606f; transition: 0.2s; }
        .cat-tab.active { background: #2f3542; color: white; font-weight: bold; }

        #sub-category-box { display: flex; gap: 6px; overflow-x: auto; margin: 10px 0 5px 0; padding: 5px 0; scrollbar-width: none; }
        #sub-category-box::-webkit-scrollbar { display: none; }
        .sub-cat-btn { padding: 5px 12px; border-radius: 10px; border: 1px solid #eee; background: #fff; font-size: 0.8rem; cursor: pointer; white-space: nowrap; color: #a4b0be; }
        .sub-cat-btn.active { border-color: var(--primary-dark); color: var(--primary-dark); background: #f9fff0; font-weight: bold; }

        #ingredient-list { 
            background: white; padding: 15px; border-radius: 20px; box-shadow: inset 0 2px 5px rgba(0,0,0,0.03);
            max-height: 350px; overflow-y: auto; text-align: left;
        }
        .group-title { font-size: 0.75rem; color: #747d8c; margin: 15px 0 8px 5px; font-weight: bold; display: flex; align-items: center; gap: 4px; cursor: pointer; }
        .group-title:first-child { margin-top: 5px; }
        .main-cat-title { color: var(--primary-dark); font-size: 0.85rem; border-bottom: 1px solid #eee; padding-bottom: 5px; margin-bottom: 12px; }
        
        .ing-grid { display: flex; flex-wrap: wrap; gap: 6px; }

        .ingredient-btn { padding: 8px 14px; border-radius: 20px; border: 1px solid #ddd; cursor: pointer; background: white; transition: 0.2s; font-size: 0.85rem; }
        .ingredient-btn.active { background: var(--primary); color: #4a542a; border-color: var(--primary-dark); font-weight: bold; }

        .selected-container { margin: 20px 0; display: none; } 
        .selected-header { display: flex; justify-content: space-between; align-items: center; margin: 0 5px 10px 5px; }
        .reset-btn { background: none; border: none; color: #ff4757; font-size: 0.75rem; cursor: pointer; font-weight: bold; text-decoration: underline; }

        .selected-scroll { display: flex; gap: 15px; overflow-x: auto; padding: 10px 5px; scrollbar-width: none; }
        .item-card { 
            flex: 0 0 105px; width: 105px; height: 130px; background: white; border-radius: 18px; 
            box-shadow: 0 6px 15px rgba(0,0,0,0.08); text-align: center; position: relative;
            padding: 10px; box-sizing: border-box; display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; transition: transform 0.2s;
        }
        .item-card img { width: 60px; height: 60px; object-fit: contain; margin-bottom: 8px; }
        .item-card span { font-size: 0.85rem; font-weight: bold; color: #2f3542; word-break: keep-all; line-height: 1.2; }
        .remove-tag { 
            position: absolute; top: -6px; right: -6px; background: #ff4757; color: white; 
            width: 24px; height: 24px; border-radius: 50%; font-size: 15px; border: 2px solid white; cursor: pointer; font-weight: bold;
            z-index: 10; display: flex; align-items: center; justify-content: center;
        }
        
        .section-title { margin: 25px 0 10px 5px; font-size: 1.1rem; display: flex; align-items: center; gap: 8px; font-weight: bold; }
        .section-divider { border: 0; height: 1px; background: #ddd; margin: 30px 0 20px 0; }
        .cocktail-item { background: white; padding: 15px; border-radius: 15px; margin-top: 15px; cursor: pointer; display: flex; gap: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: 0.2s; opacity: 0; }
        .list-thumb { width: 70px; height: 70px; border-radius: 12px; object-fit: cover; background: #eee; flex-shrink: 0; }
        
        .cocktail-info { flex-grow: 1; display: flex; flex-direction: column; width: 0; } 
        .gauge-container { background: #eee; height: 8px; border-radius: 4px; overflow: hidden; margin-top: 8px; width: 100%; } 
        .gauge-bar { height: 100%; width: 0; transition: width 1.2s cubic-bezier(0.22, 1, 0.36, 1); }
        .matching-text { font-size: 0.75em; font-weight: bold; }

        .match-badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; margin-left: 6px; vertical-align: middle; background: #e3f2fd; color: #1976d2; border: 1px solid #1976d2; font-weight: bold; }

        .m-visual-section { display: flex; align-items: center; justify-content: center; gap: 30px; margin-bottom: 25px; flex-wrap: wrap; }
        .glass-container { 
            width: 100px; height: 180px; border: 4px solid #2f3542; border-top: 1px solid rgba(0,0,0,0.05); 
            border-radius: 5px 5px 25px 25px; position: relative; overflow: hidden; display: flex; flex-direction: column; 
            background: rgba(255,255,255,0.7); box-shadow: 0 10px 25px rgba(0,0,0,0.08);
        }
        .glass-layer { width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: bold; font-size: 11px; transition: 0.5s; overflow: hidden; flex-shrink: 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .glass-layer span { white-space: nowrap; transform: scale(0.85); line-height: 1.1; }

        /* ìœ íŠœë¸Œ ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
        .video-container { position: relative; width: 100%; padding-bottom: 56.25%; height: 0; border-radius: 15px; overflow: hidden; margin-top: 15px; background: #000; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }

        .bottom-image-wrap { text-align: center; margin: 40px 0 20px 0; }
        .bottom-banner-img { max-width: 100%; height: auto; border-radius: 15px; }

        #modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 999; backdrop-filter: blur(5px); opacity: 0; transition: opacity 0.3s ease; }
        #modal-overlay.show { display: block; opacity: 1; }
        #modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, 60%); background: white; padding: 40px 25px 30px 25px; border-radius: 35px; z-index: 1000; width: 90%; max-width: 480px; text-align: center; max-height: 85vh; overflow-y: auto; box-shadow: 0 25px 60px rgba(0,0,0,0.35); opacity: 0; transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.1), opacity 0.3s ease; }
        #modal.show { display: block; transform: translate(-50%, -50%); opacity: 1; }
        .close-x { position: absolute; top: 20px; right: 20px; font-size: 32px; color: #d1d8e0; cursor: pointer; line-height: 1; transition: 0.2s; z-index: 1001; }
        
        .guide-step { text-align: left; margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 15px; }
        .guide-step-title { font-weight: bold; color: var(--primary-dark); margin-bottom: 5px; display: flex; align-items: center; gap: 8px; }
        .guide-step-desc { font-size: 0.9rem; color: #57606f; }

        #m-name { border-bottom: 4px solid var(--primary); display: inline-block; padding-bottom: 2px; font-size: 1.6rem; letter-spacing: -0.5px; margin-bottom: 4px; }
        #m-eng-name { font-size: 0.9rem; color: #a4b0be; font-weight: 500; text-transform: uppercase; }
        #m-img { width: 180px; height: 180px; object-fit: contain; margin: 0; filter: drop-shadow(0 12px 20px rgba(0,0,0,0.12)); }
        .label-text { font-size: 0.8rem; font-weight: bold; color: #a4b0be; text-align: left; margin-top: 15px; padding-left: 5px; text-transform: uppercase; }
        .m-desc-box { text-align: left; background: #fdfdfd; border-left: 5px solid #d1d8e0; padding: 15px; border-radius: 12px; font-size: 0.95rem; margin-top: 8px; color: #57606f; line-height: 1.6; white-space: pre-wrap; }
        .m-recipe-box { text-align: left; background: #f9f9f4; border-left: 5px solid var(--primary); padding: 18px; border-radius: 12px; font-size: 1rem; white-space: pre-wrap; line-height: 1.7; margin-top: 8px; }

        .add-bar-btn { width: 100%; padding: 15px; background: var(--primary); color: #4a542a; border: none; border-radius: 15px; font-size: 1rem; font-weight: bold; margin-top: 25px; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .add-bar-btn:active { transform: scale(0.98); background: var(--primary-dark); }

        .bottom-banner { position: fixed; bottom: 0; left: 0; width: 100%; height: 65px; background: #2f3542; color: white; display: flex; align-items: center; justify-content: center; z-index: 900; box-shadow: 0 -5px 15px rgba(0,0,0,0.1); font-size: 0.9rem; font-weight: bold; cursor: pointer; }
        .info-icon { color: #3498db; font-size: 0.9rem; margin-left: 4px; display: inline-flex; align-items: center; }
    </style>
</head>
<body>
<div class="container">
    <header class="header-section">
        <img src="logo.png" alt="Logo" class="main-logo" onerror="this.style.display='none'">
        <h1 class="main-title">My Smart Cocktail Bar</h1>
        <button class="guide-btn" onclick="showAppGuide()">â“ ì‚¬ìš© ë°©ë²•</button>
    </header>

    <div class="search-filter-box">
        <input type="text" id="ing-search" class="search-input" placeholder="ğŸ” ì¬ë£Œ ê²€ìƒ‰ (ì´ˆì„±ë„ ê°€ëŠ¥)" oninput="filterIngredients()">
        <div class="category-tabs" id="category-tabs"></div>
        <div id="sub-category-box"></div>
    </div>

    <div id="ingredient-list"></div>

    <div class="selected-container" id="selected-box">
        <div class="selected-header">
            <div style="font-size: 0.85rem; font-weight: bold; color: #747d8c;">ğŸ“ ë³´ìœ  ì¤‘ì¸ ì¬ë£Œ</div>
            <button class="reset-btn" onclick="clearSelected()">ì „ì²´ ì‚­ì œ</button>
        </div>
        <div class="selected-scroll" id="selected-list"></div>
    </div>
    <div id="result-list"></div>

    <div class="bottom-image-wrap">
        <img src="banner.png" alt="Banner" class="bottom-banner-img" onerror="this.parentElement.style.display='none'">
    </div>
</div>

<div class="bottom-banner" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">ğŸ¹ ë‚˜ë§Œì˜ ìŠ¤ë§ˆíŠ¸í•œ ì¹µí…Œì¼ ë°”, CKTL.GG</div>

<div id="toast">ëª¨ë“  ì¬ë£Œë¥¼ ì§€ì› ì–´ìš”</div>
<div id="modal-overlay" onclick="closeModal()"></div>
<div id="modal">
    <span class="close-x" onclick="closeModal()">&times;</span>
    <div id="modal-header-container">
        <h2 id="m-name"></h2>
        <div id="m-eng-name"></div>
    </div>
    <div id="m-ings" style="text-align: left; margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 8px; justify-content: center;"></div>
    <div id="m-content"></div>
</div>

<script>
    const DEFAULT_IMG = "default.png"; 
    let recipes = [], ingredientDocs = {}, selected = new Set();
    let currentCategory = 'ì „ì²´', currentSubCategory = 'ì „ì²´';
    let categories = new Set(['ì „ì²´']), subCategories = {}; 
    let ingredientUsage = {};

    function saveSelected() { localStorage.setItem('cktl_selected', JSON.stringify([...selected])); }
    function loadSelected() {
        const saved = localStorage.getItem('cktl_selected');
        if (saved) selected = new Set(JSON.parse(saved));
    }

    function showAppGuide() {
        document.getElementById('m-name').innerText = "ì‚¬ìš© ë°©ë²•";
        document.getElementById('m-eng-name').innerText = "How to use CKTL.GG";
        document.getElementById('m-ings').innerHTML = "";
        document.getElementById('m-content').innerHTML = `
            <div class="guide-step fade-in">
                <div class="guide-step-title">1. ì¬ë£Œ ì„ íƒí•˜ê¸°</div>
                <div class="guide-step-desc">ê²€ìƒ‰ì°½ì´ë‚˜ ì¹´í…Œê³ ë¦¬ íƒ­ì„ ì´ìš©í•´ í˜„ì¬ ê°€ì§€ê³  ìˆëŠ” ì¬ë£Œë¥¼ ì¶”ê°€í•˜ì„¸ìš”.</div>
            </div>
            <div class="guide-step fade-in" style="animation-delay: 0.1s">
                <div class="guide-step-title">2. ë ˆì‹œí”¼ í™•ì¸í•˜ê¸°</div>
                <div class="guide-step-desc">ì¬ë£Œë¥¼ ì¶”ê°€í•˜ë©´ ì¦‰ì‹œ ë§Œë“¤ ìˆ˜ ìˆëŠ” ì¹µí…Œì¼ê³¼ ì¬ë£Œê°€ ì¡°ê¸ˆ ë¶€ì¡±í•œ ì¹µí…Œì¼ì´ êµ¬ë¶„ë˜ì–´ ë‚˜íƒ€ë‚˜ìš”.</div>
            </div>
            <div class="guide-step fade-in" style="animation-delay: 0.2s">
                <div class="guide-step-title">3. ë³´ê³  ë§Œë“¤ê¸°</div>
                <div class="guide-step-desc">ë ˆì‹œí”¼ë¥¼ ëˆ„ë¥´ë©´ ì¬ë£Œ ë¹„ìœ¨ì„ ì‹œê°í™”í•œ ê²Œì´ì§€ì™€ ìƒì„¸ ì œì¡°ë²•ì„ ë³¼ ìˆ˜ ìˆì–´ìš”.</div>
            </div>
            <div class="guide-step fade-in" style="animation-delay: 0.3s">
                <div class="guide-step-title">4. ì¹µí…Œì¼ì„ ì¦ê¸°ì„¸ìš”!</div>
                <div class="guide-step-desc">ì—¬ëŸ¬ë¶„ì˜ ë§›ìˆëŠ” ì¹µí…Œì¼ì´ ì™„ì„±ë˜ì—ˆì–´ìš”. ì·¨í–¥ì— ë”°ë¼ ë¹„ìœ¨ì„ ì¡°ì ˆí•´ë³´ëŠ” ê²ƒë„ ì¢‹ì€ ì‹œë„ì—ìš”.</div>
            </div>
            <button class="add-bar-btn" onclick="closeModal()">ì´í•´í–ˆì–´ìš”!</button>
        `;
        openModal();
    }

    // ìœ íŠœë¸Œ ID ì¶”ì¶œ í•¨ìˆ˜
    function getYoutubeId(url) {
        if (!url) return null;
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
        const match = url.match(regExp);
        return (match && match[2].length === 11) ? match[2] : null;
    }

    function getChosung(str) {
        const cho = ["ã„±","ã„²","ã„´","ã„·","ã„¸","ã„¹","ã…","ã…‚","ã…ƒ","ã……","ã…†","ã…‡","ã…ˆ","ã…‰","ã…Š","ã…‹","ã…Œ","ã…","ã…"];
        let result = "";
        for(let i=0; i<str.length; i++) {
            let code = str.charCodeAt(i) - 44032;
            if(code > -1 && code < 11172) result += cho[Math.floor(code/588)];
            else result += str.charAt(i);
        }
        return result;
    }

    async function autoLoad(file, type) {
        try {
            const res = await fetch(file);
            if(!res.ok) return;
            const ab = await res.arrayBuffer();
            const wb = XLSX.read(new Uint8Array(ab), {type:'array'});
            const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            
            if(type === 'r') {
                recipes = json.map(row => ({
                    ...row, 
                    items: row['ì¬ë£Œ']?.split(',').map(i=>i.trim()) || [],
                    youtube: row['ìœ íŠœë¸Œë§í¬'] || row['ìœ íŠœë¸Œ'] || row['YouTube'] || '' 
                }));
                calculateUsage();
            } else {
                json.forEach(row => { 
                    if(row['ì¬ë£Œëª…']) {
                        const name = row['ì¬ë£Œëª…'].trim();
                        const cat = row['ì¹´í…Œê³ ë¦¬']?.trim() || 'ê¸°íƒ€';
                        let subCat = row['ì„œë¸Œì¹´í…Œê³ ë¦¬']?.trim() || '';
                        if(subCat === 'ê¸°íƒ€') subCat = ''; 
                        ingredientDocs[name] = { ...row, ì¹´í…Œê³ ë¦¬: cat, ì„œë¸Œì¹´í…Œê³ ë¦¬: subCat }; 
                        categories.add(cat);
                        if(subCat) {
                            if(!subCategories[cat]) subCategories[cat] = new Set(['ì „ì²´']);
                            subCategories[cat].add(subCat);
                        }
                    }
                });
                renderCategoryTabs();
            }
            loadSelected();
            filterIngredients();
            renderRecipes();
        } catch(e) { console.log("ë¡œë“œ ì¤‘..."); }
    }

    function calculateUsage() {
        ingredientUsage = {};
        recipes.forEach(r => { r.items.forEach(item => { ingredientUsage[item] = (ingredientUsage[item] || 0) + 1; }); });
    }

    function renderCategoryTabs() {
        const tabContainer = document.getElementById('category-tabs');
        tabContainer.innerHTML = '';
        Array.from(categories).forEach(cat => {
            const btn = document.createElement('button');
            btn.className = `cat-tab ${currentCategory === cat ? 'active' : ''}`;
            btn.innerText = cat;
            btn.onclick = () => { 
                currentCategory = cat; 
                currentSubCategory = 'ì „ì²´'; 
                renderCategoryTabs(); 
                renderSubCategories(); 
                filterIngredients(); 
            };
            tabContainer.appendChild(btn);
        });
        renderSubCategories();
    }

    function renderSubCategories() {
        const subBox = document.getElementById('sub-category-box');
        subBox.innerHTML = '';
        if (currentCategory === 'ì „ì²´' || !subCategories[currentCategory]) {
            subBox.style.display = 'none';
            return;
        }
        subBox.style.display = 'flex';
        subCategories[currentCategory].forEach(sub => {
            const btn = document.createElement('button');
            btn.className = `sub-cat-btn ${currentSubCategory === sub ? 'active' : ''}`;
            btn.innerText = sub;
            btn.onclick = () => {
                currentSubCategory = sub;
                renderSubCategories();
                filterIngredients();
            };
            subBox.appendChild(btn);
        });
    }

    function filterIngredients() {
        const query = document.getElementById('ing-search').value.toLowerCase();
        const queryCho = getChosung(query);
        const container = document.getElementById('ingredient-list');
        container.innerHTML = '';
        const groups = {}, noSubGroup = [];

        Object.keys(ingredientDocs).forEach(ing => {
            const doc = ingredientDocs[ing];
            const isMatch = ing.toLowerCase().includes(query) || getChosung(ing).includes(queryCho);
            const catMatch = currentCategory === 'ì „ì²´' || doc.ì¹´í…Œê³ ë¦¬ === currentCategory;
            const subMatch = currentSubCategory === 'ì „ì²´' || doc.ì„œë¸Œì¹´í…Œê³ ë¦¬ === currentSubCategory;

            if (isMatch && catMatch && subMatch) {
                if (ing === doc.ì¹´í…Œê³ ë¦¬ || ing === doc.ì„œë¸Œì¹´í…Œê³ ë¦¬) return;
                if (currentCategory !== 'ì „ì²´' && doc.ì„œë¸Œì¹´í…Œê³ ë¦¬) {
                    if (!groups[doc.ì„œë¸Œì¹´í…Œê³ ë¦¬]) groups[doc.ì„œë¸Œì¹´í…Œê³ ë¦¬] = [];
                    groups[doc.ì„œë¸Œì¹´í…Œê³ ë¦¬].push(ing);
                } else {
                    noSubGroup.push(ing);
                }
            }
        });

        if (currentCategory !== 'ì „ì²´' && !query) {
            const mainTitle = document.createElement('div');
            mainTitle.className = 'group-title main-cat-title';
            mainTitle.innerHTML = `<span class="info-icon">â„¹ï¸</span> ${currentCategory}`;
            mainTitle.onclick = () => showIngredientDetail(currentCategory);
            container.appendChild(mainTitle);
        }

        Object.keys(groups).sort().forEach(sCat => {
            const groupTitle = document.createElement('div');
            groupTitle.className = 'group-title';
            groupTitle.innerHTML = `<span class="info-icon">â„¹ï¸</span> ${sCat}`;
            groupTitle.onclick = () => showIngredientDetail(sCat);
            container.appendChild(groupTitle);
            const grid = document.createElement('div');
            grid.className = 'ing-grid';
            groups[sCat].sort((a,b) => (ingredientUsage[b]||0) - (ingredientUsage[a]||0)).forEach(ing => {
                createIngBtn(ing, grid);
            });
            container.appendChild(grid);
        });

        if (noSubGroup.length > 0) {
            const grid = document.createElement('div');
            grid.className = 'ing-grid';
            if (Object.keys(groups).length > 0) grid.style.marginTop = "15px";
            noSubGroup.sort((a,b) => (ingredientUsage[b]||0) - (ingredientUsage[a]||0)).forEach(ing => {
                createIngBtn(ing, grid);
            });
            container.appendChild(grid);
        }

        function createIngBtn(ing, parent) {
            const btn = document.createElement('button');
            btn.className = `ingredient-btn ${selected.has(ing) ? 'active' : ''}`;
            btn.innerText = ing;
            btn.onclick = () => toggleIngredient(ing);
            parent.appendChild(btn);
        }
        renderSelected(); 
    }

    function toggleIngredient(ing) {
        selected.has(ing) ? selected.delete(ing) : selected.add(ing);
        saveSelected(); filterIngredients(); renderRecipes();
    }

    function clearSelected() {
        selected.clear(); saveSelected(); filterIngredients(); renderRecipes(); showToast();
    }

    function showToast() {
        const t = document.getElementById('toast');
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 2000);
    }

    function renderSelected() {
        const box = document.getElementById('selected-box'), list = document.getElementById('selected-list');
        list.innerHTML = '';
        if (selected.size === 0) { box.style.display = 'none'; return; }
        box.style.display = 'block';
        selected.forEach(ing => {
            const item = document.createElement('div');
            item.className = 'item-card fade-in';
            item.onclick = () => showIngredientDetail(ing);
            item.innerHTML = `
                <button class="remove-tag" onclick="event.stopPropagation(); toggleIngredient('${ing}')">Ã—</button>
                <img src="${ingredientDocs[ing]?.ì´ë¯¸ì§€ || DEFAULT_IMG}" onerror="this.src='${DEFAULT_IMG}'">
                <span>${ing}</span>`;
            list.appendChild(item);
        });
    }

    function renderRecipes() {
        const resDiv = document.getElementById('result-list');
        resDiv.innerHTML = '';
        if(selected.size === 0) return;

        const selectedCats = new Set(), selectedSubCats = new Set();
        selected.forEach(ing => {
            const doc = ingredientDocs[ing];
            if(doc?.ì¹´í…Œê³ ë¦¬) selectedCats.add(doc.ì¹´í…Œê³ ë¦¬);
            if(doc?.ì„œë¸Œì¹´í…Œê³ ë¦¬) selectedSubCats.add(doc.ì„œë¸Œì¹´í…Œê³ ë¦¬);
        });

        const includedMatches = [], partialMatches = [];
        recipes.forEach(r => {
            let matchedCount = 0, hasStrictBrand = false;
            r.items.forEach(reqItem => {
                let isReqMatched = false;
                if (selected.has(reqItem)) {
                    isReqMatched = true;
                    const doc = ingredientDocs[reqItem];
                    if (doc && reqItem !== doc.ì¹´í…Œê³ ë¦¬ && reqItem !== doc.ì„œë¸Œì¹´í…Œê³ ë¦¬ && doc.ì¹´í…Œê³ ë¦¬ !== 'ë¶€ì¬ë£Œ') hasStrictBrand = true;
                } 
                else if (selectedCats.has(reqItem) || selectedSubCats.has(reqItem)) isReqMatched = true;
                if (isReqMatched) matchedCount++;
            });
            if (matchedCount > 0) {
                const recipeData = { ...r, matchedCount, hasStrictBrand };
                if (matchedCount === r.items.length) includedMatches.push(recipeData);
                else partialMatches.push(recipeData);
            }
        });

        includedMatches.sort((a, b) => b.matchedCount - a.matchedCount);
        partialMatches.sort((a, b) => b.matchedCount - a.matchedCount);

        if (includedMatches.length > 0) {
            resDiv.appendChild(Object.assign(document.createElement('h3'), {className: 'section-title', innerHTML: `âœ¨ ë°”ë¡œ ë§Œë“¤ ìˆ˜ ìˆëŠ” ë ˆì‹œí”¼ì—ìš”`}));
            includedMatches.forEach((r, i) => resDiv.appendChild(createCard(r, i, true)));
        }
        if (partialMatches.length > 0) {
            if(includedMatches.length > 0) resDiv.appendChild(Object.assign(document.createElement('hr'), {className: 'section-divider'}));
            resDiv.appendChild(Object.assign(document.createElement('h3'), {className: 'section-title', style: "color:#a4b0be", innerText: "ğŸ’¡ ì´ëŸ° ë ˆì‹œí”¼ë„ ìˆì–´ìš”"}));
            partialMatches.forEach((r, i) => resDiv.appendChild(createCard(r, i + 100, false)));
        }
    }

    function createCard(r, idx, isPerfectSection) {
        const selectedCats = new Set(), selectedSubCats = new Set();
        selected.forEach(ing => {
            const doc = ingredientDocs[ing];
            if(doc?.ì¹´í…Œê³ ë¦¬) selectedCats.add(doc.ì¹´í…Œê³ ë¦¬);
            if(doc?.ì„œë¸Œì¹´í…Œê³ ë¦¬) selectedSubCats.add(doc.ì„œë¸Œì¹´í…Œê³ ë¦¬);
        });
        let recipeHasCount = 0;
        r.items.forEach(item => { if (selected.has(item) || selectedCats.has(item) || selectedSubCats.has(item)) recipeHasCount++; });
        const per = Math.round((recipeHasCount / r.items.length) * 100);

        const card = document.createElement('div');
        card.className = 'cocktail-item fade-in';
        card.onclick = () => showDetail(r);
        card.innerHTML = `
            <img src="${r.ì´ë¯¸ì§€ || DEFAULT_IMG}" class="list-thumb" onerror="this.src='${DEFAULT_IMG}'">
            <div class="cocktail-info">
                <div style="display:flex; justify-content:space-between; align-items: baseline;">
                    <strong>${r.ì´ë¦„}${r.hasStrictBrand ? '<span class="match-badge">ë¸Œëœë“œ ì¼ì¹˜</span>' : ''}</strong> 
                    <small style="color:#a4b0be;">${r.ë‚œì´ë„ || ""}</small>
                </div>
                <div style="font-size:0.8em; color:#747d8c; margin:4px 0;">${r.ì¬ë£Œ}</div>
                <div class="matching-text" style="color:${per === 100 ? 'var(--primary-dark)' : '#ffa502'}">${per === 100 ? 'âœ… ì œì¡° ê°€ëŠ¥' : `ì¬ë£Œ ${recipeHasCount}/${r.items.length} ë³´ìœ `}</div>
                <div class="gauge-container"><div id="g-${idx}" class="gauge-bar" style="background:${per === 100 ? 'var(--primary)' : '#dfe4ea'}"></div></div>
            </div>`;
        setTimeout(() => { if(document.getElementById(`g-${idx}`)) document.getElementById(`g-${idx}`).style.width = per + '%'; }, 150);
        return card;
    }

    function getContrastYIQ(hexcolor){
        hexcolor = hexcolor.replace("#", "");
        if (hexcolor.length === 3) hexcolor = hexcolor.split('').map(s => s + s).join('');
        if (hexcolor.startsWith('rgba')) return 'white'; 
        const r = parseInt(hexcolor.substr(0,2),16);
        const g = parseInt(hexcolor.substr(2,2),16);
        const b = parseInt(hexcolor.substr(4,2),16);
        const yiq = ((r*299)+(g*587)+(b*114))/1000;
        return (yiq >= 128) ? '#2f3542' : 'white';
    }

    function getIngredientColor(name, index) {
        const n = name.toLowerCase();
        if (n.includes('ì£¼ìŠ¤') || n.includes('ë ˆëª¬') || n.includes('ë¼ì„') || n.includes('ì˜¤ë Œì§€')) return '#FFD54F'; 
        if (n.includes('ì‹œëŸ½') || n.includes('ì„¤íƒ•') || n.includes('ê¿€')) return '#FF8A65'; 
        if (n.includes('ì†Œë‹¤') || n.includes('ì›Œí„°') || n.includes('í† ë‹‰')) return '#B3E5FC'; 
        if (n.includes('ì§„') || n.includes('ë³´ë“œì¹´') || n.includes('í™”ì´íŠ¸ ëŸ¼') || n.includes('ë°í‚¬ë¼')) return '#E0F7FA'; 
        if (n.includes('ì»¤í”¼') || n.includes('ê¹”ë£¨ì•„') || n.includes('ì½œë¼')) return '#5D4037'; 
        if (n.includes('í¬ë¦¼') || n.includes('ìš°ìœ ')) return '#F5F5F5'; 
        if (n.includes('ê·¸ë ˆë‚˜ë”˜') || n.includes('ë”¸ê¸°') || n.includes('ìº„íŒŒë¦¬')) return '#EF5350'; 
        if (n.includes('ë¦¬íë¥´') || n.includes('ìˆ ')) return '#BA68C8'; 
        const palette = ['#ff9f43', '#ff6b6b', '#54a0ff', '#5f27cd', '#48dbfb', '#1dd1a1'];
        return palette[index % palette.length];
    }

    function showDetail(r) {
        const selectedCats = new Set(), selectedSubCats = new Set();
        selected.forEach(ing => {
            const doc = ingredientDocs[ing];
            if(doc?.ì¹´í…Œê³ ë¦¬) selectedCats.add(doc.ì¹´í…Œê³ ë¦¬);
            if(doc?.ì„œë¸Œì¹´í…Œê³ ë¦¬) selectedSubCats.add(doc.ì„œë¸Œì¹´í…Œê³ ë¦¬);
        });
    
        document.getElementById('m-name').innerText = r.ì´ë¦„;
        document.getElementById('m-eng-name').innerText = r['ì˜ì–´ì´ë¦„'] || '';
        document.getElementById('m-ings').innerHTML = r.items.map(i => {
            const isStrict = selected.has(i), isCat = selectedCats.has(i), isSubCat = selectedSubCats.has(i);
            let style = `background:#eee; color:#999;`;
            if(isStrict) style = `background:var(--primary); color:#4a542a; border:2px solid var(--primary-dark); font-weight:bold;`;
            else if(isCat || isSubCat) style = `background:#dff9fb; color:#130f40; border:1px solid #7ed6df;`;
            return `<span onclick="showIngredientDetail('${i}')" style="cursor:pointer; padding:6px 14px; border-radius:12px; font-size:0.9em; ${style}">${i}</span>`;
        }).join('');

        // --- ë¹„ìœ¨ ê²Œì´ì§€(Glass Layer) ìƒì„± ë¡œì§ ---
        const lines = r.ë ˆì‹œí”¼?.split('\n') || [];
        let layersHtml = '', totalUnit = 0, itemsToDraw = [];
        lines.forEach((line) => {
            const match = line.match(/([\d.]+)\s*(oz|ml|part|parts|dash)/i);
            if (match) {
                const val = parseFloat(match[1]);
                const unit = match[2].toLowerCase();
                const name = line.split(/[0-9]/)[0].trim() || "ì¬ë£Œ";
                itemsToDraw.push({ name, val, unit }); 
                totalUnit += val;
            }
        });

        if (totalUnit > 0) {
            layersHtml = `<div class="glass-container">`;
            itemsToDraw.forEach((item, idx) => {
                const heightPer = (item.val / totalUnit) * 100;
                const bgColor = typeof getIngredientColor === 'function' ? getIngredientColor(item.name, idx) : '#ddd';
                const textColor = typeof getContrastYIQ === 'function' ? getContrastYIQ(bgColor) : '#000';
                layersHtml += `<div class="glass-layer" style="height: ${heightPer}%; background: ${bgColor}; color: ${textColor};">
                    <span>${item.name}</span>
                    <span>${item.val}${item.unit}</span>
                </div>`;
            });
            layersHtml += `</div>`;
        }

        // --- ìœ íŠœë¸Œ ì„¹ì…˜ ë¡œì§ ---
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
        const match = r.youtube ? r.youtube.match(regExp) : null;
        const ytId = (match && match[2].length === 11) ? match[2] : null;
        const ytHtml = ytId ? `<div class="label-text">MAKING VIDEO</div><div class="video-container"><iframe src="https://www.youtube.com/embed/${ytId}" allowfullscreen></iframe></div>` : '';

        // --- ìµœì¢… í™”ë©´ êµ¬ì„± (layersHtml ì¶”ê°€ë¨) ---
        document.getElementById('m-content').innerHTML = `
            <div class="m-visual-section">
                <img src="${r.ì´ë¯¸ì§€ || DEFAULT_IMG}" id="m-img" onerror="this.src='${DEFAULT_IMG}'">
                ${layersHtml} 
            </div>
            <div class="label-text">ABOUT</div>
            <div class="m-desc-box">${r.ì„¤ëª… || 'ì¹µí…Œì¼ ì„¤ëª…ì´ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.'}</div>
            <div class="label-text">RECIPE</div>
            <div class="m-recipe-box">${r.ë ˆì‹œí”¼}</div>
            ${ytHtml}
        `;
        openModal();
    }

    function showIngredientDetail(ing) {
        // ì¬ë£Œëª… í˜¹ì€ ì¹´í…Œê³ ë¦¬/ì„œë¸Œì¹´í…Œê³ ë¦¬ëª…ìœ¼ë¡œ ë¬¸ì„œ ì°¾ê¸°
        const doc = ingredientDocs[ing] || Object.values(ingredientDocs).find(d => d.ì¹´í…Œê³ ë¦¬ === ing || d.ì„œë¸Œì¹´í…Œê³ ë¦¬ === ing);
        if(!doc) {
            document.getElementById('m-name').innerText = ing;
            document.getElementById('m-eng-name').innerText = ''; 
            document.getElementById('m-content').innerHTML = `<div class="m-recipe-box">ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
            openModal(); return;
        }

        const isRep = (ing === doc.ì¹´í…Œê³ ë¦¬ || ing === doc.ì„œë¸Œì¹´í…Œê³ ë¦¬);
        const actualName = isRep ? ing : doc.ì¬ë£Œëª…;
        
        document.getElementById('m-name').innerText = actualName;
        document.getElementById('m-eng-name').innerText = doc['ì˜ì–´ëª…'] || ''; 
        document.getElementById('m-ings').innerHTML = `<span style="background:#2f3542; color:white; padding:6px 18px; border-radius:25px; font-size:0.9em;">${doc.ì¹´í…Œê³ ë¦¬}</span>`;
        
        let html = `<div class="m-visual-section"><img id="m-img" src="${doc.ì´ë¯¸ì§€ || DEFAULT_IMG}" onerror="this.src='${DEFAULT_IMG}'"></div>
                    <div class="label-text">INGREDIENT INFO</div><div class="m-desc-box">${doc.ì„¤ëª… || 'ì„¤ëª…ì´ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.'}</div>`;
        
        if (!selected.has(actualName) && !isRep) {
            html += `<button class="add-bar-btn" onclick="toggleIngredient('${actualName}'); closeModal();">ë‚´ ë°”ì— ì¶”ê°€í•˜ê¸°</button>`;
        }

        if (isRep) {
            const targetName = ing;
            const relatedIngs = Object.keys(ingredientDocs).filter(key => {
                const d = ingredientDocs[key];
                return (d.ì¹´í…Œê³ ë¦¬ === targetName || d.ì„œë¸Œì¹´í…Œê³ ë¦¬ === targetName) && key !== targetName;
            });

            if(relatedIngs.length > 0) {
                html += `<div class="recommend-title">ğŸ“¦ ${targetName} í•˜ìœ„ ì¬ë£Œ</div><div class="selected-scroll">`;
                relatedIngs.sort((a,b) => (ingredientUsage[b]||0) - (ingredientUsage[a]||0)).forEach(subIng => {
                    const subDoc = ingredientDocs[subIng];
                    html += `
                        <div class="item-card" onclick="showIngredientDetail('${subIng}')">
                            <img src="${subDoc?.ì´ë¯¸ì§€ || DEFAULT_IMG}" onerror="this.src='${DEFAULT_IMG}'">
                            <span>${subIng}</span>
                        </div>`;
                });
                html += `</div>`;
            }
        } else {
            const recommends = recipes.filter(r => r.items.includes(doc.ì¬ë£Œëª…) || r.items.includes(doc.ì¹´í…Œê³ ë¦¬) || r.items.includes(doc.ì„œë¸Œì¹´í…Œê³ ë¦¬)).slice(0, 5);
            if(recommends.length > 0) {
                // ì¶”ì²œ ë ˆì‹œí”¼ ì„¹ì…˜ UIë¥¼ ì¬ë£Œ ëŒ€ì‹œë³´ë“œ(ê°€ë¡œ ìŠ¤í¬ë¡¤ ì¹´ë“œ) ìŠ¤íƒ€ì¼ë¡œ ë³€ê²½
                html += `<div class="recommend-title">ğŸ¹ ì¶”ì²œ ë ˆì‹œí”¼</div><div class="selected-scroll">`;
                recommends.forEach(r => {
                    html += `
                        <div class="item-card" onclick="showDetail(${JSON.stringify(r).replace(/"/g, '&quot;')})">
                        <img src="${r.ì´ë¯¸ì§€ || DEFAULT_IMG}" onerror="this.src='${DEFAULT_IMG}'" style="border-radius:10px; object-fit:cover;">
                        <span>${r.ì´ë¦„}</span>
                    </div>`;
                });
                html += `</div>`;
            }
        }
        document.getElementById('m-content').innerHTML = html;
        openModal();
    }

    function openModal() {
        const m = document.getElementById('modal'), o = document.getElementById('modal-overlay');
        m.style.display = o.style.display = 'block'; m.scrollTop = 0;
        setTimeout(() => { m.classList.add('show'); o.classList.add('show'); }, 10);
    }
    function closeModal() {
        const m = document.getElementById('modal'), o = document.getElementById('modal-overlay');
        m.classList.remove('show');
        o.classList.remove('show');
    
        setTimeout(() => {
            m.style.display = o.style.display = 'none';
            // íŒì—…ì´ ì™„ì „íˆ ë‹«íŒ í›„ ë‚´ìš©ì„ ë¹„ì›Œ ì˜¤ë””ì˜¤/ì˜ìƒì„ ì¢…ë£Œí•©ë‹ˆë‹¤.
            document.getElementById('m-content').innerHTML = '';
            document.getElementById('m-ings').innerHTML = '';
        }, 300);
    }
    window.onload = () => { autoLoad('cocktails.xlsx', 'r'); autoLoad('ingredients.xlsx', 'i'); };
</script>
</body>
</html>